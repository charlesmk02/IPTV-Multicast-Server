/**
 * This function reads the config file generated by the scan command
 * and converts it into a JSON file.
 * It returns an object containing all the channels.
 */

const { readFileSync, writeFileSync } = require('fs')

exports.convertIntoJSON = function () {
    try {
        /**
         * Each line of the file corresponds to a channel
         * We store the lines in an array of strings
         */
        var line = readFileSync('/home/pi/channels.conf').toString().split("\n")
        // The following array will include all the lines converted into objects
        var array = []
        /**
         * We iterate over the array of lines
         * The parameters on a line are separate by a ':'
         * We store them in variables 
         */
        for (i in line) {
            let [
                name,
                frequency,
                inversion,
                bandwidth,
                innerFec,
                fec,
                modulation,
                transmissionMode,
                guardInterval,
                hierarchy,
                vpid,
                audio,
                sid
            ] = line[i].split(':')
            /**
             * The following object represents the line at index i
             * It includes all the variables created above
             */
            let obj = {
                name,
                frequency,
                inversion,
                bandwidth,
                innerFec,
                fec,
                modulation,
                transmissionMode,
                guardInterval,
                hierarchy,
                vpid,
                audio,
                sid
            }
            array.push(obj)
        }
        /**
         * The following object includes all the channels with their name as keys
         * Each key contains an object with useful parameters :
         * frequency, multicast address (set on client-side),
         * sid (identifies the channel), and checked (for client-side)
         */
        var channels = {};
        for (let i = 0; i < array.length; i++) {
            let name = array[i].name;
            channels[name] = {
                frequency: parseInt(array[i].frequency),
                ip: '',
                sid: parseInt(array[i].sid),
                checked: true
            };
        }
        // This object is stored in a JSON file
        var json = JSON.stringify(channels, null, 2);
        writeFileSync('/home/pi/channels.json', json)

        return channels
    } catch (err) {
        throw err
    }
}